<!DOCTYPE html>
<!--
    å…¥èŒ9å‘¨å¹´çºªå¿µæ—¥è½¯ä»¶
    ä½œè€…: MYJ
    æè¿°: ä¸€ä¸ªç”¨äºçºªå¿µå…¥èŒ9å‘¨å¹´çš„æ—¥å†åº”ç”¨ç¨‹åºï¼Œæ”¯æŒå¤‡å¿˜å½•ç®¡ç†ã€æ—¥æœŸæ ‡è®°ã€æ•°æ®å¯¼å…¥å¯¼å‡ºç­‰åŠŸèƒ½
    ç‰¹æ€§:
      - æ—¥å†è§†å›¾å±•ç¤ºé‡è¦æ—¥æœŸ
      - å¤‡å¿˜å½•æ·»åŠ å’Œç®¡ç†åŠŸèƒ½
      - å†œå†æ—¥æœŸæ˜¾ç¤º
      - æ³•å®šèŠ‚å‡æ—¥æ ‡è¯†
      - æ•°æ®å¯¼å…¥å¯¼å‡º(CSV/JSONæ ¼å¼)
      - å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
      - çºªå¿µæ—¥ç»Ÿè®¡ä¿¡æ¯å±•ç¤º
-->
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…¥èŒ9å‘¨å¹´çºªå¿µæ—¥è½¯ä»¶</title>
  <!-- å¼•å…¥å†œå†è®¡ç®—åº“ -->
  <script src="https://cdn.bootcdn.net/ajax/libs/lunar-javascript/1.7.4/lunar.min.js"></script>
  <style>
    /* 
     * æ ¹å˜é‡å®šä¹‰
     * å®šä¹‰äº†åº”ç”¨ç¨‹åºçš„ä¸»è¦é¢œè‰²ä¸»é¢˜å’Œå­—ä½“
     */
    :root {
      --bg: #FFF8F6;
      --card: #ffffff;
      --primary: #FF8CBC;
      --accent: #FFD6EA;
      --muted: #8B8B8B;
      --shadow: 0 8px 18px rgba(230, 40, 120, 0.08);
      font-family: "Helvetica Neue", "PingFang SC", "Microsoft Yahei", Arial, sans-serif;
    }

    /* 
     * é€šç”¨æ ·å¼è®¾ç½®
     * è®¾ç½®ç›’æ¨¡å‹ã€bodyæ ·å¼å’Œåº”ç”¨å¸ƒå±€
     */
    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: linear-gradient(180deg, #FFF8F6 0%, #FFF0F4 100%);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* 
     * åº”ç”¨å¸ƒå±€è®¾ç½®
     * ä½¿ç”¨CSS Gridå¸ƒå±€ï¼Œå®šä¹‰ä¸»å†…å®¹åŒºåŸŸå’Œä¾§è¾¹æ 
     */
    .app {
      max-width: 1100px;
      margin: 24px auto 0;
      padding: 20px;
      display: grid;
      grid-template-columns: 560px 360px;
      /* å¢åŠ 200pxå®½åº¦ (ä»360pxåˆ°560px) */
      gap: 18px;
      flex: 1;
    }

    /* 
     * å¤´éƒ¨æ ·å¼
     * åŒ…å«logoå’Œæ§åˆ¶æŒ‰é’®åŒºåŸŸçš„å¸ƒå±€
     */
    header {
      grid-column: 1/-1;
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .logo .badge {
      width: 62px;
      height: 62px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--primary), #FFD6EA);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      box-shadow: var(--shadow)
    }

    h1 {
      margin: 0;
      font-size: 20px
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center
    }

    /* 
     * æŒ‰é’®æ ·å¼
     * å®šä¹‰é€šç”¨æŒ‰é’®æ ·å¼å’Œæ‚¬åœæ•ˆæœ
     */
    button {
      background: var(--card);
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      cursor: pointer;
      transition: all 0.2s ease
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08)
    }

    /* 
     * æ—¥å†å¡ç‰‡æ ·å¼
     * åŒ…å«æ—¥å†æ ‡é¢˜ã€æ˜ŸæœŸæ ‡é¢˜å’Œæ—¥æœŸç½‘æ ¼çš„æ ·å¼
     */
    .calendar-card {
      background: var(--card);
      padding: 18px;
      border-radius: 16px;
      box-shadow: var(--shadow)
    }

    .month-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px
    }

    .month-title {
      font-weight: 700
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      color: var(--muted);
      font-size: 13px;
      /* è°ƒæ•´å†…è¾¹è·ä½¿å…¶ä¸æ—¥æœŸç½‘æ ¼å¯¹é½ */
      padding: 6px 3px;
      margin: 0;
      /* æ·»åŠ æ–‡æœ¬å±…ä¸­å¯¹é½ */
      text-align: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      /* æ·»åŠ å†…è¾¹è·ä»¥åŒ¹é…æ˜ŸæœŸæ ‡é¢˜ */
      padding: 0 3px;
    }

    /* 
     * æ—¥æœŸå•å…ƒæ ¼æ ·å¼
     * å®šä¹‰æ¯ä¸ªæ—¥æœŸæ ¼å­çš„å¤–è§‚å’Œç‰¹æ®Šæ—¥æœŸçš„æ ‡è®°
     */
    .cell {
      background: linear-gradient(180deg, #fff, #fff);
      border-radius: 12px;
      min-height: 84px;
      padding: 8px;
      position: relative;
      border: 1px dashed rgba(200, 200, 200, 0.06);
      /* æ·»åŠ æ–‡æœ¬å±…ä¸­å¯¹é½ */
      text-align: center;
    }

    .cell.out {
      opacity: 0.35
    }

    .cell .date {
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: 12px;
      color: var(--muted)
    }

    .cell .memo-dot {
      position: absolute;
      left: 8px;
      bottom: 8px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      background: var(--accent);
      max-width: 90%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis
    }

    /* 
     * ä¾§è¾¹æ æ ·å¼
     * åŒ…å«ç»Ÿè®¡å¡ç‰‡ã€å½“å‰æ—¥æœŸä¿¡æ¯ã€å¤‡å¿˜å½•åˆ—è¡¨ç­‰ç»„ä»¶çš„æ ·å¼
     */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 14px;
      box-shadow: var(--shadow)
    }

    .today-badge {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .highlight {
      background: linear-gradient(90deg, #FFF1F6, #FFF8F2);
      padding: 8px;
      border-radius: 10px
    }

    .memos-list {
      max-height: 420px;
      overflow: auto;
      padding-right: 6px
    }

    .memo-item {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #FFF7FA;
      border: 1px solid #FFEAF2;
      transition: all 0.2s ease
    }

    .memo-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 140, 188, 0.15)
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .actions {
      display: flex;
      gap: 6px
    }

    input[type=file] {
      display: none
    }

    .cute {
      font-size: 12px;
      color: #FF5B9A
    }

    /* 
     * æ¨¡æ€æ¡†æ ·å¼
     * å®šä¹‰å¼¹å‡ºçª—å£çš„æ ·å¼ï¼ŒåŒ…æ‹¬èƒŒæ™¯é®ç½©å’Œå†…å®¹åŒºåŸŸ
     */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 10, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100
    }

    .modal {
      width: 420px;
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.18)
    }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #EEE
    }

    footer {
      grid-column: 1/-1;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      padding: 16px 0;
      margin-top: 0;
    }

    .anniv-tag {
      background: linear-gradient(90deg, #FFDEE9, #FFD6EA);
      padding: 6px 8px;
      border-radius: 999px;
      font-weight: 700;
      color: #9B1556
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px
    }

    .sidebar-title {
      font-weight: 700;
      font-size: 16px
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px
    }

    .stat-card {
      padding: 12px;
      border-radius: 10px;
      background: #FFF7FA;
      text-align: center
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary)
    }

    .stat-label {
      font-size: 11px;
      color: var(--muted)
    }

    .memo-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px
    }

    .memo-actions button {
      font-size: 10px;
      padding: 4px 8px
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--muted)
    }

    .empty-state img {
      width: 60px;
      opacity: 0.5;
      margin-bottom: 8px
    }

    /* 
     * çƒŸèŠ±æ•ˆæœæ ·å¼
     * å®šä¹‰åº†ç¥åŠ¨ç”»æ•ˆæœçš„æ ·å¼
     */
    .fireworks-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .firework {
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }

    /* 
     * å¹³æ¿ç«¯åª’ä½“æŸ¥è¯¢
     * è°ƒæ•´ä¸­ç­‰å±å¹•è®¾å¤‡ä¸Šçš„å¸ƒå±€
     */
    @media(max-width:980px) {
      .app {
        grid-template-columns: 1fr;
        margin: 16px auto 0;
        padding: 10px;
      }

      .sidebar {
        order: 2
      }

      footer {
        padding: 12px 0;
      }
    }

    /* 
     * æ‰‹æœºç«¯åª’ä½“æŸ¥è¯¢
     * ä¼˜åŒ–å°å±å¹•è®¾å¤‡ä¸Šçš„æ˜¾ç¤ºæ•ˆæœ
     */
    @media(max-width:768px) {
      .app {
        padding: 10px;
        margin: 16px auto 0;
      }

      header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      .logo {
        width: 100%;
      }

      .controls {
        width: 100%;
        flex-wrap: wrap;
        justify-content: center;
      }

      button {
        padding: 6px 10px;
        font-size: 14px;
      }

      .calendar-card {
        padding: 12px;
      }

      .grid {
        gap: 4px;
      }

      .cell {
        min-height: 60px;
        padding: 4px;
      }

      .cell .date {
        top: 4px;
        right: 6px;
        font-size: 10px;
      }

      .cell .memo-dot {
        font-size: 10px;
        padding: 2px 6px;
        left: 4px;
        bottom: 4px;
      }

      .modal {
        width: 95%;
        padding: 12px;
      }

      textarea {
        min-height: 80px;
      }

      .stats-grid {
        gap: 8px;
      }

      .stat-card {
        padding: 8px;
      }

      .stat-value {
        font-size: 16px;
      }

      .memos-list {
        max-height: 300px;
      }

      .memo-item {
        padding: 8px;
      }

      footer {
        font-size: 12px;
        margin-top: auto;
        padding: 10px 0;
      }
    }

    /* 
     * å°å±å¹•æ‰‹æœºä¼˜åŒ–
     * é’ˆå¯¹æå°å±å¹•è®¾å¤‡çš„è¿›ä¸€æ­¥ä¼˜åŒ–
     */
    @media(max-width:480px) {
      .app {
        padding: 8px;
        margin: 12px auto 0;
      }

      .logo .badge {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        font-size: 18px;
      }

      h1 {
        font-size: 18px;
      }

      .small {
        font-size: 11px;
      }

      .controls {
        gap: 6px;
      }

      button {
        padding: 5px 8px;
        font-size: 13px;
        border-radius: 8px;
      }

      .weekdays {
        font-size: 12px;
        padding: 4px;
      }

      .cell {
        min-height: 50px;
      }

      .cell .date {
        font-size: 9px;
      }

      .cell .memo-dot {
        font-size: 9px;
        padding: 2px 4px;
      }

      .stat-value {
        font-size: 14px;
      }

      .stat-label {
        font-size: 10px;
      }

      .sidebar-title {
        font-size: 15px;
      }

      footer {
        font-size: 11px;
        padding: 8px 0;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="badge">å²š</div>
        <div>
          <h1>å…¥èŒ9å‘¨å¹´çºªå¿µæ—¥</h1>
          <div class="small">èº«ä½“å¥åº·ï¼Œç”Ÿæ´»æ„‰å¿«ï¼Œå·¥ä½œé¡ºåˆ©</div>
        </div>
      </div>
      <div class="controls">
        <button id="prev">â—€ ä¸Šæœˆ</button>
        <button id="next">ä¸‹æœˆ â–¶</button>
        <button id="today">å›åˆ°é»˜è®¤</button>
        <button id="goToToday">å›åˆ°ä»Šæ—¥</button>
        <button id="exportCsv">å¯¼å‡º CSV</button>
        <button id="exportJson">å¯¼å‡º JSON</button>
        <label title="å¯¼å…¥å¤‡ä»½å½• (CSV æˆ– JSON)"><input id="fileIn" type="file" accept=".csv,.json" />å¯¼å…¥</label>
      </div>
    </header>

    <section class="calendar-card">
      <div class="month-nav">
        <div class="month-title" id="monthTitle">2026 å¹´ 1 æœˆ</div>
        <div class="today-badge">
          <div class="anniv-tag">9th</div>
          <div class="small">2017-01-11 â†’ 2026-01-11</div>
        </div>
      </div>
      <div class="weekdays">
        <div>æ—¥</div>
        <div>ä¸€</div>
        <div>äºŒ</div>
        <div>ä¸‰</div>
        <div>å››</div>
        <div>äº”</div>
        <div>å…­</div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <aside class="sidebar">
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="card">
        <div class="sidebar-header">
          <div class="sidebar-title">ğŸ“Š çºªå¿µæ—¥ç»Ÿè®¡</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalMemos">0</div>
            <div class="stat-label">æ€»å¤‡å¿˜å½•</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="currentMonthMemos">0</div>
            <div class="stat-label">æœ¬æœˆå¤‡å¿˜å½•</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="upcomingMemos">0</div>
            <div class="stat-label">å³å°†åˆ°æœŸ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="annivCount">9</div>
            <div class="stat-label">å‘¨å¹´çºªå¿µ</div>
          </div>
        </div>
      </div>

      <!-- å½“å‰æ—¥æœŸä¿¡æ¯ -->
      <div class="card">
        <div class="sidebar-header">
          <div class="sidebar-title">ğŸ“… é‡è¦çš„æ—¥å­</div>
          <div class="small">ä»Šå¤©ï¼š<span id="nowStr"></span></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div>
            <div style="font-weight:700;color:var(--primary)">2026-01-11</div>
            <div class="small">å…¥èŒ9å‘¨å¹´</div>
          </div>
          <div class="anniv-tag">9å‘¨å¹´</div>
        </div>
      </div>

      <!-- å¤‡å¿˜å½•åˆ—è¡¨ -->
      <div class="card">
        <div class="sidebar-header">
          <div class="sidebar-title">ğŸ“ å¤‡å¿˜å½•åˆ—è¡¨</div>
          <div class="small">å…±<span id="memoCount">0</span>æ¡</div>
        </div>
        <div class="memos-list" id="memosList">
          <!-- åŠ¨æ€å†…å®¹ -->
        </div>
      </div>

      <!-- å¿«é€Ÿæ“ä½œ -->
      <div class="card">
        <div class="sidebar-header">
          <div class="sidebar-title">âš¡ å¿«é€Ÿæ“ä½œ</div>
          <div class="small">æ•°æ®ç®¡ç†</div>
        </div>
        <div class="row" style="flex-wrap:wrap">
          <button id="clearAll">æ¸…ç©ºå…¨éƒ¨</button>
          <button id="downloadSample">ä¸‹è½½ç¤ºä¾‹</button>
          <button id="exportCsv2">å¯¼å‡ºCSV</button>
          <button id="exportJson2">å¯¼å‡ºJSON</button>
        </div>
      </div>
    </aside>

  </div>
  <footer>å…¥èŒ9å‘¨å¹´çºªå¿µè½¯ä»¶ By AILL</footer>
</body>

<!-- æ¨¡æ€æ¡† -->
<div id="modal" style="display:none" class="modal-bg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700" id="modalDate">2026-01-11</div>
      <div class="small"><span id="diffYears"></span></div>
    </div>
    <div class="small" id="lunarDate" style="margin-bottom: 8px; color: #FF8CBC;"></div>
    <textarea id="memoText" placeholder="åœ¨æ­¤è¾“å…¥å¤‡å¿˜å½•..."></textarea>
    <div style="display:flex;justify-content:space-between;margin-top:8px">
      <div class="small">æ”¯æŒå¯¼å‡ºä¸º CSV/JSON</div>
      <div class="actions">
        <button id="deleteMemo">åˆ é™¤</button>
        <button id="saveMemo">ä¿å­˜</button>
        <button id="closeModal">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
  // åˆå§‹è®¾ç½®
  // å®šä¹‰é»˜è®¤è§†å›¾æ—¥æœŸå’Œå…¥èŒçºªå¿µæ—¥æ—¥æœŸ
  const DEFAULT_VIEW = new Date(2026, 0, 11); // 2026-01-11
  const ANNIV_FROM = new Date(2017, 0, 11); // 2017-01-11

  // è·å–DOMå…ƒç´ å¼•ç”¨
  const grid = document.getElementById('grid');
  const monthTitle = document.getElementById('monthTitle');
  const nowStr = document.getElementById('nowStr');
  const memosList = document.getElementById('memosList');
  const modalBg = document.getElementById('modal');
  const modalDate = document.getElementById('modalDate');
  const memoText = document.getElementById('memoText');
  const diffYears = document.getElementById('diffYears');
  const totalMemos = document.getElementById('totalMemos');
  const currentMonthMemos = document.getElementById('currentMonthMemos');
  const upcomingMemos = document.getElementById('upcomingMemos');
  const memoCount = document.getElementById('memoCount');

  // åˆå§‹åŒ–è§†å›¾æ—¥æœŸå’Œä»Šæ—¥æ—¥æœŸ
  let view = new Date(DEFAULT_VIEW);
  let today = new Date(); // æ·»åŠ ä»Šæ—¥æ—¥æœŸå˜é‡
  
  // æ•°æ®å­˜å‚¨ç»“æ„ï¼š{ 'YYYY-MM-DD': 'memo text' }
  const STORAGE_KEY = 'anniv_memos_v1';

  // ä¸­å›½æ³•å®šèŠ‚å‡æ—¥æ•°æ® (éƒ¨åˆ†å¸¸è§èŠ‚å‡æ—¥)
  // åŒ…å«å›ºå®šæ—¥æœŸèŠ‚å‡æ—¥å’Œå˜åŠ¨æ—¥æœŸèŠ‚å‡æ—¥ï¼ˆå¦‚æ˜¥èŠ‚ã€æ¸…æ˜èŠ‚ç­‰ï¼‰
  const HOLIDAYS = {
    // å…ƒæ—¦
    '01-01': 'å…ƒæ—¦',
    
    // æ˜¥èŠ‚ç›¸å…³æ—¥æœŸ (å†œå†æ­£æœˆåˆä¸€ç­‰ï¼Œè¿™é‡Œä½¿ç”¨éƒ¨åˆ†å¹´ä»½çš„å®é™…å…¬å†æ—¥æœŸ)
    '2017-01-28': 'æ˜¥èŠ‚', '2017-01-29': 'åˆäºŒ', '2017-01-30': 'åˆä¸‰', '2017-01-31': 'åˆå››', 
    '2017-02-01': 'åˆäº”', '2017-02-02': 'åˆå…­', '2017-02-03': 'åˆä¸ƒ',
    '2018-02-16': 'æ˜¥èŠ‚', '2018-02-17': 'åˆäºŒ', '2018-02-18': 'åˆä¸‰', '2018-02-19': 'åˆå››',
    '2018-02-20': 'åˆäº”', '2018-02-21': 'åˆå…­', '2018-02-22': 'åˆä¸ƒ',
    '2019-02-05': 'æ˜¥èŠ‚', '2019-02-06': 'åˆäºŒ', '2019-02-07': 'åˆä¸‰', '2019-02-08': 'åˆå››',
    '2019-02-09': 'åˆäº”', '2019-02-10': 'åˆå…­', '2019-02-11': 'åˆä¸ƒ',
    '2020-01-25': 'æ˜¥èŠ‚', '2020-01-26': 'åˆäºŒ', '2020-01-27': 'åˆä¸‰', '2020-01-28': 'åˆå››',
    '2020-01-29': 'åˆäº”', '2020-01-30': 'åˆå…­', '2020-01-31': 'åˆä¸ƒ',
    '2021-02-12': 'æ˜¥èŠ‚', '2021-02-13': 'åˆäºŒ', '2021-02-14': 'åˆä¸‰', '2021-02-15': 'åˆå››',
    '2021-02-16': 'åˆäº”', '2021-02-17': 'åˆå…­', '2021-02-18': 'åˆä¸ƒ',
    '2022-02-01': 'æ˜¥èŠ‚', '2022-02-02': 'åˆäºŒ', '2022-02-03': 'åˆä¸‰', '2022-02-04': 'åˆå››',
    '2022-02-05': 'åˆäº”', '2022-02-06': 'åˆå…­', '2022-02-07': 'åˆä¸ƒ',
    '2023-01-22': 'æ˜¥èŠ‚', '2023-01-23': 'åˆäºŒ', '2023-01-24': 'åˆä¸‰', '2023-01-25': 'åˆå››',
    '2023-01-26': 'åˆäº”', '2023-01-27': 'åˆå…­', '2023-01-28': 'åˆä¸ƒ',
    '2024-02-10': 'æ˜¥èŠ‚', '2024-02-11': 'åˆäºŒ', '2024-02-12': 'åˆä¸‰', '2024-02-13': 'åˆå››',
    '2024-02-14': 'åˆäº”', '2024-02-15': 'åˆå…­', '2024-02-16': 'åˆä¸ƒ',
    '2025-01-29': 'æ˜¥èŠ‚', '2025-01-30': 'åˆäºŒ', '2025-01-31': 'åˆä¸‰', '2025-02-01': 'åˆå››',
    '2025-02-02': 'åˆäº”', '2025-02-03': 'åˆå…­', '2025-02-04': 'åˆä¸ƒ',
    '2026-02-17': 'æ˜¥èŠ‚', '2026-02-18': 'åˆäºŒ', '2026-02-19': 'åˆä¸‰', '2026-02-20': 'åˆå››',
    '2026-02-21': 'åˆäº”', '2026-02-22': 'åˆå…­', '2026-02-23': 'åˆä¸ƒ',
    
    // æ¸…æ˜èŠ‚ (éƒ¨åˆ†å¹´ä»½)
    '2017-04-04': 'æ¸…æ˜èŠ‚',
    '2018-04-05': 'æ¸…æ˜èŠ‚',
    '2019-04-05': 'æ¸…æ˜èŠ‚',
    '2020-04-04': 'æ¸…æ˜èŠ‚',
    '2021-04-04': 'æ¸…æ˜èŠ‚',
    '2022-04-05': 'æ¸…æ˜èŠ‚',
    '2023-04-05': 'æ¸…æ˜èŠ‚',
    '2024-04-04': 'æ¸…æ˜èŠ‚',
    '2025-04-04': 'æ¸…æ˜èŠ‚',
    '2026-04-05': 'æ¸…æ˜èŠ‚',
    '2027-04-05': 'æ¸…æ˜èŠ‚',
    '2028-04-04': 'æ¸…æ˜èŠ‚',
    '2029-04-04': 'æ¸…æ˜èŠ‚',
    
    // åŠ³åŠ¨èŠ‚
    '05-01': 'åŠ³åŠ¨èŠ‚',
    
    // ç«¯åˆèŠ‚ (éƒ¨åˆ†å¹´ä»½)
    '2017-05-30': 'ç«¯åˆèŠ‚',
    '2018-06-18': 'ç«¯åˆèŠ‚',
    '2019-06-07': 'ç«¯åˆèŠ‚',
    '2020-06-25': 'ç«¯åˆèŠ‚',
    '2021-06-14': 'ç«¯åˆèŠ‚',
    '2022-06-03': 'ç«¯åˆèŠ‚',
    '2023-06-22': 'ç«¯åˆèŠ‚',
    '2024-06-10': 'ç«¯åˆèŠ‚',
    '2025-05-31': 'ç«¯åˆèŠ‚',
    '2026-05-20': 'ç«¯åˆèŠ‚',
    '2027-05-09': 'ç«¯åˆèŠ‚',
    '2028-05-27': 'ç«¯åˆèŠ‚',
    '2029-05-16': 'ç«¯åˆèŠ‚',
    
    // ä¸­ç§‹èŠ‚ (éƒ¨åˆ†å¹´ä»½)
    '2017-10-04': 'ä¸­ç§‹èŠ‚',
    '2018-09-24': 'ä¸­ç§‹èŠ‚',
    '2019-09-13': 'ä¸­ç§‹èŠ‚',
    '2020-10-01': 'ä¸­ç§‹èŠ‚',
    '2021-09-21': 'ä¸­ç§‹èŠ‚',
    '2022-09-10': 'ä¸­ç§‹èŠ‚',
    '2023-09-29': 'ä¸­ç§‹èŠ‚',
    '2024-09-17': 'ä¸­ç§‹èŠ‚',
    '2025-10-06': 'ä¸­ç§‹èŠ‚',
    '2026-09-25': 'ä¸­ç§‹èŠ‚',
    '2027-09-15': 'ä¸­ç§‹èŠ‚',
    '2028-10-04': 'ä¸­ç§‹èŠ‚',
    '2029-09-22': 'ä¸­ç§‹èŠ‚',
    
    // å›½åº†èŠ‚
    '10-01': 'å›½åº†èŠ‚'
  };

  // é»˜è®¤æ•°æ®
  // åˆå§‹åŒ–é»˜è®¤å¤‡å¿˜å½•æ•°æ®
  const defaultData = {
    '2017-01-11': 'å…¥èŒçºªå¿µæ—¥',
    '2026-01-11': 'å…¥èŒ9å‘¨å¹´'
  };

  /**
   * ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤‡å¿˜å½•æ•°æ®
   * @returns {Object} å¤‡å¿˜å½•æ•°æ®å¯¹è±¡
   */
  function loadData() {
    let raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
      return { ...defaultData };
    }
    try {
      return JSON.parse(raw) || {};
    } catch (e) {
      return {};
    }
  }
  
  /**
   * å°†å¤‡å¿˜å½•æ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
   * @param {Object} obj - è¦ä¿å­˜çš„å¤‡å¿˜å½•æ•°æ®å¯¹è±¡
   */
  function saveData(obj) { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

  // åŠ è½½å¤‡å¿˜å½•æ•°æ®
  let memos = loadData();

  /**
   * æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD å­—ç¬¦ä¸²
   * @param {Date} d - è¦æ ¼å¼åŒ–çš„æ—¥æœŸå¯¹è±¡
   * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸå­—ç¬¦ä¸²
   */
  function fmt(d) {
    const y = d.getFullYear(); const m = ('0' + (d.getMonth() + 1)).slice(-2); const day = ('0' + d.getDate()).slice(-2); return `${y}-${m}-${day}`;
  }

  /**
   * è·å–æŒ‡å®šæ—¥æœŸçš„å†œå†ä¿¡æ¯
   * @param {string} dateStr - æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
   * @returns {string} å†œå†æ—¥æœŸä¿¡æ¯
   */
  function getLunarDate(dateStr) {
    try {
      const date = new Date(dateStr);
      console.log('å°è¯•ä½¿ç”¨lunar-javascriptè®¡ç®—å†œå†æ—¥æœŸ:', dateStr);
      
      // æ£€æŸ¥åº“æ˜¯å¦å·²æ­£ç¡®åŠ è½½
      if (typeof Solar === 'undefined' || typeof Lunar === 'undefined') {
        console.log('lunar-javascriptåº“æœªæ­£ç¡®åŠ è½½ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ');
        return getSimpleLunarDate(date);
      }
      
      console.log('Solarå’ŒLunarå¯¹è±¡å¯ç”¨');
      // ä½¿ç”¨ lunar-javascript åº“è®¡ç®—å†œå†æ—¥æœŸ
      const solar = Solar.fromYmd(date.getFullYear(), date.getMonth() + 1, date.getDate());
      const lunar = solar.getLunar();
      const result = lunar.toString();
      console.log('lunar-javascriptè®¡ç®—ç»“æœ:', result);
      // è¿”å›å®Œæ•´çš„å†œå†æ—¥æœŸæ ¼å¼
      return result;
    } catch (e) {
      console.error('å†œå†è®¡ç®—å‡ºé”™:', e);
      // å‡ºé”™æ—¶è¿”å›ç®€åŒ–ç‰ˆæœ¬
      try {
        return getSimpleLunarDate(new Date(dateStr));
      } catch (e2) {
        console.error('é™çº§å¤„ç†ä¹Ÿå¤±è´¥:', e2);
        return 'å†œå†æ—¥æœŸ';
      }
    }
  }
  
  /**
   * ç®€åŒ–ç‰ˆå†œå†è®¡ç®—ï¼ˆç”¨äºé™çº§å¤„ç†ï¼‰
   * @param {Date} date - è¦è®¡ç®—å†œå†çš„æ—¥æœŸå¯¹è±¡
   * @returns {string} å†œå†æ—¥æœŸä¿¡æ¯
   */
  function getSimpleLunarDate(date) {
    // è¿™é‡Œåº”è¯¥ä½¿ç”¨çœŸå®çš„å†œå†è®¡ç®—ï¼Œä½†ç”±äºå¤æ‚æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿‘ä¼¼å€¼
    // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨ä¸“ä¸šçš„å†œå†åº“
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
      
    // è¿™åªæ˜¯ä¸€ä¸ªç¤ºä¾‹æ˜ å°„ï¼Œå®é™…çš„å†œå†è®¡ç®—éå¸¸å¤æ‚
    // 2017å¹´æ˜¥èŠ‚ç›¸å…³æ—¥æœŸçš„å†œå†æ˜ å°„
    const lunarMap2017 = {
      '2017-01-28': 'å†œå†æ­£æœˆåˆä¸€', '2017-01-29': 'å†œå†æ­£æœˆåˆäºŒ', '2017-01-30': 'å†œå†æ­£æœˆåˆä¸‰', '2017-01-31': 'å†œå†æ­£æœˆåˆå››', 
      '2017-02-01': 'å†œå†æ­£æœˆåˆäº”', '2017-02-02': 'å†œå†æ­£æœˆåˆå…­', '2017-02-03': 'å†œå†æ­£æœˆåˆä¸ƒ', '2017-02-04': 'å†œå†æ­£æœˆåˆå…«',
      '2017-02-05': 'å†œå†æ­£æœˆåˆä¹', '2017-02-06': 'å†œå†æ­£æœˆåˆå', '2017-02-07': 'å†œå†æ­£æœˆåä¸€', '2017-02-08': 'å†œå†æ­£æœˆåäºŒ',
      '2017-02-09': 'å†œå†æ­£æœˆåä¸‰', '2017-02-10': 'å†œå†æ­£æœˆåå››', '2017-02-11': 'å†œå†æ­£æœˆåäº”', '2017-02-12': 'å†œå†æ­£æœˆåå…­',
      '2017-02-13': 'å†œå†æ­£æœˆåä¸ƒ', '2017-02-14': 'å†œå†æ­£æœˆåå…«', '2017-02-15': 'å†œå†æ­£æœˆåä¹', '2017-02-16': 'å†œå†æ­£æœˆäºŒå',
      '2017-02-17': 'å†œå†æ­£æœˆå»¿ä¸€', '2017-02-18': 'å†œå†æ­£æœˆå»¿äºŒ', '2017-02-19': 'å†œå†æ­£æœˆå»¿ä¸‰', '2017-02-20': 'å†œå†æ­£æœˆå»¿å››',
      '2017-02-21': 'å†œå†æ­£æœˆå»¿äº”', '2017-02-22': 'å†œå†æ­£æœˆå»¿å…­', '2017-02-23': 'å†œå†æ­£æœˆå»¿ä¸ƒ', '2017-02-24': 'å†œå†æ­£æœˆå»¿å…«',
      '2017-02-25': 'å†œå†æ­£æœˆå»¿ä¹', '2017-02-26': 'å†œå†äºŒæœˆåˆä¸€', '2017-02-27': 'å†œå†äºŒæœˆåˆäºŒ', '2017-02-28': 'å†œå†äºŒæœˆåˆä¸‰'
    };
    
    // 2026å¹´éƒ¨åˆ†æ—¥æœŸçš„å†œå†æ˜ å°„
    const lunarMap2026 = {
      '2026-01-01': 'å†œå†åä¸€æœˆåä¸‰',
      '2026-01-02': 'å†œå†åä¸€æœˆåå››',
      '2026-01-03': 'å†œå†åä¸€æœˆåäº”',
      '2026-01-04': 'å†œå†åä¸€æœˆåå…­',
      '2026-01-05': 'å†œå†åä¸€æœˆåä¸ƒ',
      '2026-01-06': 'å†œå†åä¸€æœˆåå…«',
      '2026-01-07': 'å†œå†åä¸€æœˆåä¹',
      '2026-01-08': 'å†œå†åä¸€æœˆäºŒå',
      '2026-01-09': 'å†œå†åä¸€æœˆå»¿ä¸€',
      '2026-01-10': 'å†œå†åä¸€æœˆå»¿äºŒ',
      '2026-01-11': 'å†œå†åä¸€æœˆå»¿ä¸‰',
      '2026-01-12': 'å†œå†åä¸€æœˆå»¿å››',
      '2026-01-13': 'å†œå†åä¸€æœˆå»¿äº”',
      '2026-01-14': 'å†œå†åä¸€æœˆå»¿å…­',
      '2026-01-15': 'å†œå†åä¸€æœˆå»¿ä¸ƒ',
      '2026-01-16': 'å†œå†åä¸€æœˆå»¿å…«',
      '2026-01-17': 'å†œå†åä¸€æœˆå»¿ä¹',
      '2026-01-18': 'å†œå†è…Šæœˆåˆä¸€',
      '2026-01-19': 'å†œå†è…ŠæœˆåˆäºŒ',
      '2026-01-20': 'å†œå†è…Šæœˆåˆä¸‰',
      '2026-01-21': 'å†œå†è…Šæœˆåˆå››',
      '2026-01-22': 'å†œå†è…Šæœˆåˆäº”',
      '2026-01-23': 'å†œå†è…Šæœˆåˆå…­',
      '2026-01-24': 'å†œå†è…Šæœˆåˆä¸ƒ',
      '2026-01-25': 'å†œå†è…Šæœˆåˆå…«',
      '2026-01-26': 'å†œå†è…Šæœˆåˆä¹',
      '2026-01-27': 'å†œå†è…Šæœˆåˆå',
      '2026-01-28': 'å†œå†è…Šæœˆåä¸€',
      '2026-01-29': 'å†œå†è…ŠæœˆåäºŒ',
      '2026-01-30': 'å†œå†è…Šæœˆåä¸‰',
      '2026-01-31': 'å†œå†è…Šæœˆåå››',
        
      '2026-02-01': 'å†œå†è…Šæœˆåäº”',
      '2026-02-02': 'å†œå†è…Šæœˆåå…­',
      '2026-02-03': 'å†œå†è…Šæœˆåä¸ƒ',
      '2026-02-04': 'å†œå†è…Šæœˆåå…«',
      '2026-02-05': 'å†œå†è…Šæœˆåä¹',
      '2026-02-06': 'å†œå†è…ŠæœˆäºŒå',
      '2026-02-07': 'å†œå†è…Šæœˆå»¿ä¸€',
      '2026-02-08': 'å†œå†è…Šæœˆå»¿äºŒ',
      '2026-02-09': 'å†œå†è…Šæœˆå»¿ä¸‰',
      '2026-02-10': 'å†œå†è…Šæœˆå»¿å››',
      '2026-02-11': 'å†œå†è…Šæœˆå»¿äº”',
      '2026-02-12': 'å†œå†è…Šæœˆå»¿å…­',
      '2026-02-13': 'å†œå†è…Šæœˆå»¿ä¸ƒ',
      '2026-02-14': 'å†œå†è…Šæœˆå»¿å…«',
      '2026-02-15': 'å†œå†è…Šæœˆå»¿ä¹',
      '2026-02-16': 'å†œå†è…Šæœˆä¸‰å',
      '2026-02-17': 'å†œå†æ­£æœˆåˆä¸€', // æ˜¥èŠ‚
      '2026-02-18': 'å†œå†æ­£æœˆåˆäºŒ',
      '2026-02-19': 'å†œå†æ­£æœˆåˆä¸‰',
      '2026-02-20': 'å†œå†æ­£æœˆåˆå››',
      '2026-02-21': 'å†œå†æ­£æœˆåˆäº”',
      '2026-02-22': 'å†œå†æ­£æœˆåˆå…­',
      '2026-02-23': 'å†œå†æ­£æœˆåˆä¸ƒ',
      '2026-02-24': 'å†œå†æ­£æœˆåˆå…«',
      '2026-02-25': 'å†œå†æ­£æœˆåˆä¹',
      '2026-02-26': 'å†œå†æ­£æœˆåˆå',
      '2026-02-27': 'å†œå†æ­£æœˆåä¸€',
      '2026-02-28': 'å†œå†æ­£æœˆåäºŒ'
    };
      
    const dateKey = `${year}-${('0' + month).slice(-2)}-${('0' + day).slice(-2)}`;
    // åˆå¹¶æ‰€æœ‰å¹´ä»½çš„æ˜ å°„
    const allLunarMap = {...lunarMap2017, ...lunarMap2026};
    
    if (allLunarMap[dateKey]) {
      return allLunarMap[dateKey];
    }
      
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ å°„ï¼Œåˆ™è¿”å›æ›´å…·ä½“çš„æ ¼å¼
    const monthNames = [
      'æ­£æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
      'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'
    ];
    
    const dayNames = [
      'åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
      'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
      'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'
    ];
    
    // è¿”å›ä¸€ä¸ªæ›´åˆç†çš„é»˜è®¤å€¼ï¼Œè€Œä¸æ˜¯ç®€å•çš„"å†œå†æ—¥æœŸ"
    return `å†œå†${monthNames[(month - 1) % 12]}${dayNames[(day - 1) % 30]}`;
  }

  /**
   * æ¸²æŸ“æ—¥å†è§†å›¾
   * æ ¹æ®å½“å‰è§†å›¾æ—¥æœŸç”Ÿæˆå¹¶æ˜¾ç¤ºæ—¥å†ç½‘æ ¼
   */
  function render() {
    grid.innerHTML = '';
    const year = view.getFullYear();
    const month = view.getMonth();
    monthTitle.textContent = `${year} å¹´ ${month + 1} æœˆ`;
    const firstDay = new Date(year, month, 1);
    const startDay = firstDay.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    // previous month's tail
    const prevMonthDays = new Date(year, month, 0).getDate();
    const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;
    for (let i = 0; i < totalCells; i++) {
      const cell = document.createElement('div'); cell.className = 'cell';
      let dayNum = i - startDay + 1;
      let dateObj;
      if (dayNum <= 0) { // previous month
        dateObj = new Date(year, month - 1, prevMonthDays + dayNum);
        cell.classList.add('out');
      } else if (dayNum > daysInMonth) { // next month
        dateObj = new Date(year, month + 1, dayNum - daysInMonth);
        cell.classList.add('out');
      } else {
        dateObj = new Date(year, month, dayNum);
      }
      const dateStr = fmt(dateObj);
      const dateLabel = document.createElement('div'); dateLabel.className = 'date'; dateLabel.textContent = dateObj.getDate();
      cell.appendChild(dateLabel);
      
      // æ·»åŠ èŠ‚å‡æ—¥æ ‡è¯† - ä¼˜å…ˆæ˜¾ç¤ºå…·ä½“æ—¥æœŸçš„èŠ‚æ—¥ï¼ˆå¦‚æ˜¥èŠ‚ã€æ¸…æ˜èŠ‚ç­‰ï¼‰
      let holidayName = null;
      // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šå¹´ä»½çš„èŠ‚æ—¥ï¼ˆå¦‚æ˜¥èŠ‚ã€æ¸…æ˜èŠ‚ç­‰ï¼‰
      if (HOLIDAYS[dateStr]) {
        holidayName = HOLIDAYS[dateStr];
      } 
      // å¦‚æœæ²¡æœ‰ç‰¹å®šå¹´ä»½çš„èŠ‚æ—¥ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æ˜¯å›ºå®šæ—¥æœŸçš„èŠ‚æ—¥ï¼ˆå¦‚å…ƒæ—¦ã€åŠ³åŠ¨èŠ‚ã€å›½åº†èŠ‚ï¼‰
      else {
        const monthDay = `${('0' + (dateObj.getMonth() + 1)).slice(-2)}-${('0' + dateObj.getDate()).slice(-2)}`;
        holidayName = HOLIDAYS[monthDay];
      }
      
      if (holidayName) {
        const holidayBadge = document.createElement('div');
        holidayBadge.style.position = 'absolute';
        holidayBadge.style.left = '8px';
        holidayBadge.style.top = '12px'; // è°ƒæ•´ä½ç½®é¿å…ä¸9å‘¨å¹´æ ‡è¯†é‡å 
        holidayBadge.style.background = 'rgba(255, 91, 154, 0.15)'; // ä½¿ç”¨ä¸åŒçš„èƒŒæ™¯è‰²
        holidayBadge.style.padding = '2px 4px';
        holidayBadge.style.borderRadius = '4px';
        holidayBadge.style.fontSize = '10px';
        holidayBadge.style.color = '#FF5B9A';
        holidayBadge.style.fontWeight = 'bold';
        holidayBadge.textContent = holidayName;
        cell.appendChild(holidayBadge);
      }
      
      if (memos[dateStr]) {
        const m = document.createElement('div'); m.className = 'memo-dot'; m.textContent = memos[dateStr]; cell.appendChild(m);
      }
      // highlight 2026-01-11
      if (dateStr === '2026-01-11') {
        cell.style.boxShadow = '0 6px 18px rgba(255,126,164,0.14)';
        const badge = document.createElement('div'); 
        badge.style.position = 'absolute'; 
        badge.style.left = '8px'; 
        badge.style.top = '24px'; 
        badge.style.background = 'rgba(255,140,180,0.12)'; 
        badge.style.padding = '4px 6px'; 
        badge.style.borderRadius = '8px'; 
        badge.style.fontSize = '11px'; 
        badge.textContent = '9å‘¨å¹´'; 
        cell.appendChild(badge);
      }
      
      // ä¸ºä»Šæ—¥æ·»åŠ ä¸2026-01-11ç›¸åŒçš„é€‰ä¸­æ ·å¼
      const todayStr = fmt(today);
      if (dateStr === todayStr) {
        cell.style.boxShadow = '0 6px 18px rgba(255,126,164,0.14)';
        const todayBadge = document.createElement('div'); 
        todayBadge.style.position = 'absolute'; 
        todayBadge.style.left = '8px'; 
        todayBadge.style.top = '2px'; 
        todayBadge.style.background = 'rgba(255,140,180,0.12)'; 
        todayBadge.style.padding = '4px 6px'; 
        todayBadge.style.borderRadius = '8px'; 
        todayBadge.style.fontSize = '11px'; 
        todayBadge.textContent = 'ä»Šæ—¥'; 
        cell.appendChild(todayBadge);
      }

      cell.addEventListener('click', () => openModal(dateStr));
      grid.appendChild(cell);
    }
    renderMemosList();
    updateStats();
    nowStr.textContent = new Date().toISOString().slice(0, 10);
  }

  /**
   * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
   * è®¡ç®—å¹¶æ›´æ–°ä¾§è¾¹æ ä¸­çš„å„ç§ç»Ÿè®¡æ•°æ®
   */
  function updateStats() {
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    const memoKeys = Object.keys(memos);
    // æ·»åŠ é»˜è®¤å¤‡å¿˜å½•æ•°é‡ï¼ˆ2ä¸ªï¼‰
    totalMemos.textContent = memoKeys.length + 2;
    memoCount.textContent = memoKeys.length + 2;

    // è®¡ç®—æœ¬æœˆå¤‡å¿˜å½•æ•°é‡
    const currentYear = view.getFullYear();
    const currentMonth = view.getMonth();
    const currentMonthMemosCount = memoKeys.filter(key => {
      const date = new Date(key);
      return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
    }).length;
    currentMonthMemos.textContent = currentMonthMemosCount;

    // è®¡ç®—å³å°†åˆ°æœŸçš„å¤‡å¿˜å½•ï¼ˆæœªæ¥7å¤©å†…ï¼‰
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 7);
    const upcomingCount = memoKeys.filter(key => {
      const memoDate = new Date(key);
      return memoDate >= today && memoDate <= nextWeek;
    }).length;
    upcomingMemos.textContent = upcomingCount;

  }

  /**
   * æ¸²æŸ“å¤‡å¿˜å½•åˆ—è¡¨
   * åœ¨ä¾§è¾¹æ ä¸­æ˜¾ç¤ºæ‰€æœ‰å¤‡å¿˜å½•æ¡ç›®
   */
  function renderMemosList() {
    memosList.innerHTML = '';
    let keys = Object.keys(memos).sort();

    // å§‹ç»ˆæ˜¾ç¤ºé»˜è®¤å¤‡å¿˜å½•ï¼šå…¥èŒçºªå¿µæ—¥å’Œ9å‘¨å¹´çºªå¿µæ—¥
    const defaultMemos = [
      { date: '2017-01-11', text: 'å…¥èŒçºªå¿µæ—¥' },
      { date: '2026-01-11', text: 'å…¥èŒ9å‘¨å¹´' }
    ];

    // æ˜¾ç¤ºé»˜è®¤å¤‡å¿˜å½•
    defaultMemos.forEach(item => {
      const div = document.createElement('div'); div.className = 'memo-item';
      const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'flex-start';
      const left = document.createElement('div'); left.style.flex = '1'; left.style.minWidth = '0';
      left.innerHTML = `
          <div style="font-weight:700;color:var(--primary)">${item.date}</div>
          <div class="small" style="margin-top:4px;white-space:normal;word-break:break-word">${item.text}</div>
          <div class="small" style="margin-top:4px">${calcDiffYears(item.date, '2017-01-11')}</div>
        `;
      const right = document.createElement('div'); right.style.flexShrink = '0'; right.style.marginLeft = '8px';
      right.innerHTML = `
          <div class="memo-actions">
            <button data-date="${item.date}" class="jump">è·³è½¬</button>
            <button data-date="${item.date}" class="edit">ç¼–è¾‘</button>
          </div>
        `;
      row.appendChild(left); row.appendChild(right); div.appendChild(row);
      memosList.appendChild(div);
    });

    // æ˜¾ç¤ºç”¨æˆ·è‡ªå®šä¹‰çš„å¤‡å¿˜å½•ï¼ˆæ’é™¤é»˜è®¤å¤‡å¿˜å½•ï¼‰
    const defaultDates = defaultMemos.map(memo => memo.date);
    const userMemos = keys.filter(key => !defaultDates.includes(key));

    userMemos.forEach(k => {
      const div = document.createElement('div'); div.className = 'memo-item';
      const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'flex-start';
      const left = document.createElement('div'); left.style.flex = '1'; left.style.minWidth = '0';
      left.innerHTML = `
          <div style="font-weight:700;color:var(--primary)">${k}</div>
          <div class="small" style="margin-top:4px;white-space:normal;word-break:break-word">${memos[k]}</div>
          <div class="small" style="margin-top:4px">${calcDiffYears(k, '2017-01-11')}</div>
        `;
      const right = document.createElement('div'); right.style.flexShrink = '0'; right.style.marginLeft = '8px';
      right.innerHTML = `
          <div class="memo-actions">
            <button data-date="${k}" class="jump">è·³è½¬</button>
            <button data-date="${k}" class="edit">ç¼–è¾‘</button>
          </div>
        `;
      row.appendChild(left); row.appendChild(right); div.appendChild(row);
      memosList.appendChild(div);
    });

    // bind buttons
    memosList.querySelectorAll('button.jump').forEach(b => b.addEventListener('click', e => {
      const d = e.target.dataset.date;
      const dt = new Date(d);
      view = new Date(dt.getFullYear(), dt.getMonth(), 11);
      render();
    }));
    memosList.querySelectorAll('button.edit').forEach(b => b.addEventListener('click', e => {
      openModal(e.target.dataset.date);
    }));

    // æ›´æ–°å¤‡å¿˜å½•è®¡æ•°ï¼ˆåŒ…æ‹¬é»˜è®¤å¤‡å¿˜å½•ï¼‰
    memoCount.textContent = keys.length + defaultMemos.length;
  }

  // æ¨¡æ€æ¡†ç›¸å…³å˜é‡å’Œå‡½æ•°
  let modalCurrentDate = null;
  
  /**
   * æ‰“å¼€å¤‡å¿˜å½•ç¼–è¾‘æ¨¡æ€æ¡†
   * @param {string} dateStr - æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
   */
  function openModal(dateStr) {
    modalBg.style.display = 'flex';
    modalCurrentDate = dateStr;
    modalDate.textContent = dateStr;
    memoText.value = memos[dateStr] || '';
    diffYears.textContent = calcDiffYears(dateStr, '2017-01-11');
    
    // æ˜¾ç¤ºå†œå†ä¿¡æ¯
    const lunarDate = document.getElementById('lunarDate');
    lunarDate.textContent = getLunarDate(dateStr);
  }
  
  /**
   * å…³é—­å¤‡å¿˜å½•ç¼–è¾‘æ¨¡æ€æ¡†
   */
  function closeModal() { modalBg.style.display = 'none'; modalCurrentDate = null; }

  // ç»‘å®šæ¨¡æ€æ¡†ç›¸å…³æŒ‰é’®äº‹ä»¶
  document.getElementById('closeModal').addEventListener('click', () => closeModal());
  document.getElementById('saveMemo').addEventListener('click', () => {
    if (!modalCurrentDate) return;
    const txt = memoText.value.trim();
    if (txt === '') { delete memos[modalCurrentDate]; } else { memos[modalCurrentDate] = txt; }
    saveData(memos); render(); closeModal();
  });
  document.getElementById('deleteMemo').addEventListener('click', () => {
    if (!modalCurrentDate) return;
    delete memos[modalCurrentDate]; saveData(memos); render(); closeModal();
  });

  /**
   * è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¹´ä»½å·®
   * @param {string} d1str - ç»“æŸæ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
   * @param {string} d2str - å¼€å§‹æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
   * @returns {string} æ ¼å¼åŒ–åçš„å¹´ä»½å·®å­—ç¬¦ä¸²
   */
  function calcDiffYears(d1str, d2str) {
    try {
      const d1 = new Date(d1str); const d2 = new Date(d2str);
      let years = d1.getFullYear() - d2.getFullYear();
      // adjust if before anniversary
      const mm = d1.getMonth() - d2.getMonth();
      if (mm < 0 || (mm === 0 && d1.getDate() < d2.getDate())) years--;
      return `${d2str} â†’ ${d1str} ï¼š ${years} å¹´`;
    } catch (e) { return '' }
  }

  // å¯¼èˆªæŒ‰é’®äº‹ä»¶ç»‘å®š
  document.getElementById('prev').addEventListener('click', () => { view = new Date(view.getFullYear(), view.getMonth() - 1, 1); render(); });
  document.getElementById('next').addEventListener('click', () => { view = new Date(view.getFullYear(), view.getMonth() + 1, 1); render(); });
  document.getElementById('today').addEventListener('click', () => { view = new Date(DEFAULT_VIEW); render(); });
  // æ·»åŠ å›åˆ°ä»Šæ—¥æŒ‰é’®äº‹ä»¶ç›‘å¬
  document.getElementById('goToToday').addEventListener('click', () => {
    view = new Date(today.getFullYear(), today.getMonth(), 1);
    render();
  });

  /**
   * å¯¼å‡ºå¤‡å¿˜å½•ä¸ºCSVæ ¼å¼
   * ç”Ÿæˆå¹¶ä¸‹è½½CSVæ–‡ä»¶
   */
  function exportCsv() {
    const rows = [['date', 'memo']];
    Object.keys(memos).sort().forEach(k => { rows.push([k, memos[k].replace(/\n/g, '\\n')]); });
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'memos_export.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
  document.getElementById('exportCsv').addEventListener('click', exportCsv);
  document.getElementById('exportCsv2').addEventListener('click', exportCsv);

  /**
   * å¯¼å‡ºå¤‡å¿˜å½•ä¸ºJSONæ ¼å¼
   * ç”Ÿæˆå¹¶ä¸‹è½½JSONæ–‡ä»¶
   */
  function exportJson() {
    const blob = new Blob([JSON.stringify(memos, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'memos_backup.json'; a.click(); URL.revokeObjectURL(a.href);
  }
  document.getElementById('exportJson').addEventListener('click', exportJson);
  document.getElementById('exportJson2').addEventListener('click', exportJson);

  // å¯¼å…¥æ–‡ä»¶å¤„ç†
  document.getElementById('fileIn').addEventListener('change', async (e) => {
    const f = e.target.files[0]; if (!f) return; const txt = await f.text();
    if (f.name.endsWith('.json')) {
      try { const jd = JSON.parse(txt); memos = { ...memos, ...jd }; saveData(memos); render(); alert('å·²å¯¼å…¥ JSON æ•°æ®'); }
      catch (err) { alert('JSON è§£æå¤±è´¥'); }
    } else if (f.name.endsWith('.csv')) {
      // very simple CSV parse
      const lines = txt.split(/\r?\n/).filter(Boolean);
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const parts = parseCsvLine(line);
        if (parts.length >= 2) { const date = parts[0].trim(); const memo = parts[1].replace(/\\n/g, '\n'); memos[date] = memo; }
      }
      saveData(memos); render(); alert('å·²å¯¼å…¥ CSV æ•°æ®');
    } else { alert('åªæ”¯æŒ csv æˆ– json æ–‡ä»¶'); }
    e.target.value = '';
  });

  /**
   * è§£æCSVè¡Œæ•°æ®
   * @param {string} line - CSVè¡Œæ•°æ®
   * @returns {Array} è§£æåçš„å­—æ®µæ•°ç»„
   */
  function parseCsvLine(line) {
    const out = []; let cur = ''; let inq = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { if (inq && line[i + 1] === '"') { cur += '"'; i++; } else inq = !inq; }
      else if (ch === ',' && !inq) { out.push(cur); cur = ''; }
      else cur += ch;
    }
    out.push(cur); return out;
  }

  // æ¸…ç©ºæ•°æ®å’Œä¸‹è½½ç¤ºä¾‹äº‹ä»¶ç»‘å®š
  document.getElementById('clearAll').addEventListener('click', () => { if (confirm('ç¡®è®¤æ¸…ç©ºå…¨éƒ¨å¤‡å¿˜å½•ï¼Ÿæ— æ³•æ¢å¤ã€‚')) { memos = {}; saveData(memos); render(); } });
  document.getElementById('downloadSample').addEventListener('click', () => {
    const sample = {
      '2017-01-11': 'å…¥èŒçºªå¿µæ—¥',
      '2026-01-11': '9å‘¨å¹´åº†'
    };
    const blob = new Blob([JSON.stringify(sample, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'memos_sample.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  // åˆå§‹æ¸²æŸ“
  render();
  
  // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥åº“æ˜¯å¦æ­£ç¡®åŠ è½½
  window.addEventListener('load', () => {
    if (typeof Solar === 'undefined' || typeof Lunar === 'undefined') {
      console.warn('lunar-javascriptåº“æœªæ­£ç¡®åŠ è½½');
    } else {
      console.log('lunar-javascriptåº“å·²æ­£ç¡®åŠ è½½');
    }
    
    createFireworks();
    // 9ç§’åç§»é™¤çƒŸèŠ±æ•ˆæœ
    setTimeout(() => {
      const container = document.querySelector('.fireworks-container');
      if (container) {
        container.remove();
      }
    }, 9000);
  });
</script>

<!-- çƒŸèŠ±æ•ˆæœå®¹å™¨ -->
<div class="fireworks-container"></div>

<!-- çƒŸèŠ±æ•ˆæœJavaScript -->
<script>
  /**
   * åˆ›å»ºçƒŸèŠ±æ•ˆæœ
   * ç”Ÿæˆåº†ç¥å…¥èŒ9å‘¨å¹´çš„çƒŸèŠ±åŠ¨ç”»
   */
  function createFireworks() {
    const container = document.querySelector('.fireworks-container');
    if (!container) return;
    
    // åˆ›å»ºå¤šä¸ªçƒŸèŠ±
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        createFirework(container);
      }, i * 800);
    }
  }
  
  /**
   * åˆ›å»ºå•ä¸ªçƒŸèŠ±æ•ˆæœ
   * @param {HTMLElement} container - çƒŸèŠ±å®¹å™¨å…ƒç´ 
   */
  function createFirework(container) {
    const colors = ['#FF8CBC', '#FFD6EA', '#FFF8F6', '#FFF0F4', '#FF5B9A', '#8B8B8B'];
    const x = Math.random() * window.innerWidth;
    const y = Math.random() * window.innerHeight;
    
    // åˆ›å»ºç²’å­
    for (let i = 0; i < 100; i++) {
      const firework = document.createElement('div');
      firework.classList.add('firework');
      
      // éšæœºé¢œè‰²
      const color = colors[Math.floor(Math.random() * colors.length)];
      firework.style.backgroundColor = color;
      
      // åˆå§‹ä½ç½®
      firework.style.left = `${x}px`;
      firework.style.top = `${y}px`;
      
      container.appendChild(firework);
      
      // éšæœºç§»åŠ¨æ–¹å‘å’Œè·ç¦»
      const angle = Math.random() * Math.PI * 2;
      const distance = 50 + Math.random() * 150;
      const duration = 2000 + Math.random() * 2000; // å»¶é•¿åŠ¨ç”»æŒç»­æ—¶é—´åˆ°2-4ç§’
      
      // åŠ¨ç”»
      const animation = firework.animate([
        { 
          transform: `translate(0, 0) scale(1)`,
          opacity: 1
        },
        { 
          transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0)`,
          opacity: 0
        }
      ], {
        duration: duration,
        easing: 'cubic-bezier(0.1, 0.8, 0.2, 1)'
      });
      
      // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
      animation.onfinish = () => {
        firework.remove();
      };
    }
  }
</script>
</body>

</html>
